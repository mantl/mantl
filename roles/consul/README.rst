.. versionadded:: 0.1

.. todo:: make a reference to registrator in the paragraph below.

`Consul <https://www.consul.io/>`_ is used in the project to
coordinate service discovery, specifically using the inbuilt DNS
server.

Variables
---------

You can use these variables to customize your Consul installation (see
the :ref:`Consul Example Playbook <consul-example-playbook>` for how
to do so.) You'll typically want to set at least :data:`consul_dc`,
:data:`consul_server_group`, and :data:`consul_gossip_key`. These
variables are roughly sorted from most commonly used to least.

.. data:: consul_dc

   If set, consul will advertise this datacenter (default ``dc1``)

.. data:: consul_server_group

   Group to configure join IPs from. For example, if this value is
   ``consul_server``, IPs will be calculated from the hosts in that
   group and added to the list of servers to join. Defaults to
   ``all``.

.. data:: consul_gossip_key

   If set, this is used to encrypt gossip communication between
   nodes. This is unset by default, but you *really should* set one
   up. You can get a suitable key (16 bytes of random data encoded in
   base64) by running ``openssl rand 16 | base64``.

.. data:: consul_advertise

   IP address Consul will advertise as available for other nodes to
   connect to. Defaults to the value of
   ``ansible_default_ipv4.address``.

.. data:: consul_is_server

   Whether this node should be a server (``true``) or an agent
   (``false``). (default ``true``)

.. data:: consul_bootstrap_expect

   The number of servers to expect to join the cluster before
   bootstrapping. This is used in place of a two-phase bootstrap
   (where one node bootstraps and then restarts as a regular server.)
   This is set by default to be the number of servers in
   :data:`consul_server_group`, but can be changed where the situation warrants
   (for example if you have *many* servers, you may want to set this
   to be a low number like 3.)

.. data:: consul_image

   Docker image to pull and run (default ``progrium/consul``)

.. data:: consul_tag

   Tag of :data:`consul_image` to pull (default ``latest``)

.. data:: retry_join

   Automatically generated by the calculation described in
   :data:`consul_server_group`, but you can override it for custom
   behavior.

.. _consul-example-playbook:

Example Playbook
----------------

.. code-block:: yaml+jinja

    ---
    - hosts: all
      roles:
        - common
        - docker

    - hosts: dc1
      roles:
        - role: consul
          # NOTE: this gossip key and the one for DC2 have to be the same!
          gossip_key: "ggVIrhEzqe7W/65YZ9fYFA=="
          server_group: dc1
          dc: dc1

    - hosts: dc2
      roles:
        - role: consul
          gossip_key: "ggVIrhEzqe7W/65YZ9fYFA=="
          server_group: dc2
          dc: dc2
