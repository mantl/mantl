Getting Started
===============

.. note:: This document assumes you have a `working Ansible
          installation`_. If you don't, install Ansible before
          continuing. This can be done simply by running ``pip install -r
          requirements.txt`` from the root of the project.

The Mantl project uses Ansible to bring up nodes and clusters. This generally
means that you need three things:

 1. hosts to use as the base for your cluster
 2. an `inventory file`_ with the hosts you want to be modified.
 3. a playbook to show which components should go where.

Provisioning Cloud Hosts
------------------------

The playbooks and roles in this project will work on whatever provider
(or metal) you care to spin up, as long as it can run CentOS 7 or
equivalent. However, here are some guides to get started on common
platforms:

.. toctree::
   :maxdepth: 1

   openstack.rst
   gce.rst
   aws.rst
   digitalocean.rst
   vsphere.rst
   softlayer.rst
   clc.rst

Setting up DNS
--------------

You can set up your DNS records with Terraform:

.. toctree::
   :maxdepth: 2

   dns.rst


Setting up Authentication and Authorization
-------------------------------------------

Before you begin, you'll want to run the ``security-setup`` script in the
root directory. This will create and set passwords, authentication, and
certificates. For more information, see the :doc:`security-setup
<../security/security_setup>` documentation.

Deploying software via Ansible
------------------------------

.. note:: Ansible requres a Python 2 binary. If yours is not at /usr/bin/python,
          please view the `Ansible FAQ <http://docs.ansible.com/faq.html>`_. You
          can add an extra variable to the following commands, e.g.
          ``ansible -e ansible_python_interpreter=/path/to/python2``.

In the following examples, we're going to assume you deployed hosts using
Terraform. This project ships with a dynamic inventory file to read Terraform
``.tfstate`` files. If you are running ansible from the root directory of the
project, this inventory file will be used by default. If not, or to use a custom
inventory file, you can use the ``-i`` argument of ``ansible`` or
``ansible-playbook`` to specify the inventory file path. For example:

.. code-block:: shell

   ansible-playbook -i path/to/inventory -e @security.yml mantl.yml

First, ping the servers to ensure they are reachable via ssh:

.. code-block:: shell

  ansible all -m ping

If any servers fail to connect, check your connection by adding ``-vvvv``
for verbose SSH debugging and try again to view the errors in more detail.

.. warning::

   Due to updated packages in the recent CentOS-7 (1511) release, it is critical
   that you upgrade operating system packages on all server before proceeding
   with deployment:

   .. code-block:: shell

      ansible-playbook playbooks/upgrade-packages.yml

   If you neglect to upgrade packages, you will likely experience multiple
   failures, particularly around Consul. See issues `#907
   <https://github.com/CiscoCloud/mantl/issues/907>`_ and
   `#927
   <https://github.com/CiscoCloud/mantl/issues/927>`_ for
   more details.

Next, deploy the software. First, you'll need to customize a playbook. A sample
can be found at ``sample.yml`` in the root directory, you can find
more about customizing this at :doc:`playbook`. The main change you'll want
to make is changing ``consul_acl_datacenter`` to your preferred ACL datacenter.
If you only have one datacenter, you can remove this variable. Next, assuming
you've placed the filled-out template at ``mantl.yml``:

.. code-block:: shell

  ansible-playbook -e @security.yml mantl.yml

The deployment will probably take a while as all tasks are completed.

Checking your deployment
------------------------

Once your deployment has completed, you will be able to access the Mantl UI
in your browser by connecting to one of the control nodes.

If you need the IP address of your nodes, you can use ``terraform.py``:

.. code-block:: shell

   $ plugins/inventory/terraform.py --hostfile
   ## begin hosts generated by terraform.py ##
   xxx.xxx.xxx.xxx         mantl-control-01
   xxx.xxx.xxx.xxx         mantl-control-02
   xxx.xxx.xxx.xxx         mantl-control-03
   xxx.xxx.xxx.xxx         mantl-edge-01
   xxx.xxx.xxx.xxx         mantl-edge-02
   xxx.xxx.xxx.xxx         mantl-worker-001
   xxx.xxx.xxx.xxx         mantl-worker-002
   xxx.xxx.xxx.xxx         mantl-worker-003
   ## end hosts generated by terraform.py ##

When you enter a control node's IP address into your browser, you'll likely get
prompted about invalid security certificates if you have SSL/TLS turned on.
(Follow your browser's instructions on how to access a site without a valid
cert.) Then, you will be presented with a basic access authentication prompt.
The username and password for this is based upon the ``security.yml`` file that
you generated earlier with the ``security-setup`` script.

Here is what you should be looking at after you connect and authenticate:

.. image:: https://raw.githubusercontent.com/CiscoCloud/nginx-mantlui/master/screenshot.png
     :alt: Screenshot of Mantl UI in action
     :target: https://github.com/CiscoCloud/nginx-mantlui

Click the image to go to the `GitHub project`_

Customizing your deployment
---------------------------

Below are guides customizing your deployment:

.. toctree::
   :maxdepth: 1

   ssh_users.rst  
   playbook.rst
   dockerfile.rst

.. _generated dynamically: http://docs.ansible.com/intro_dynamic_inventory.html
.. _inventory file: http://docs.ansible.com/intro_inventory.html
.. _playbook: http://docs.ansible.com/playbooks.html
.. _working Ansible installation: http://docs.ansible.com/intro_installation.html#installing-the-control-machine
.. _GitHub project: https://github.com/CiscoCloud/nginx-mantlui

Restarting your deployment
--------------------------

To restart your deployment and make sure all components are restarted and
working correctly, use the ``playbooks/reboot-hosts.yml`` playbook.

.. code-block:: shell

    ansible-playbook playbooks/reboot-hosts.yml

Using a Docker Container to Provision your Cluster
---------------------------------------------------

You can also provision your cluster by running a docker container. See :doc:`dockerfile` for more information.
